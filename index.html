<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Çizgi Roman Atölyesi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Bangers&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Roboto Condensed',sans-serif;background:#111827;background-image:radial-gradient(#374151 1px,transparent 1px);background-size:20px 20px}
    .bangers-font{font-family:'Bangers',cursive}
    .comic-panel{background:#374151;border:4px solid #000;box-shadow:0 0 15px rgba(0,0,0,.5);position:relative;overflow:hidden}
    .panel-loader{border-top-color:#f59e0b;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .speech-bubble{position:absolute;background:#fff;color:#000;border-radius:.4em;padding:10px;font-weight:bold;cursor:move;border:2px solid #000;box-shadow:2px 2px 4px rgba(0,0,0,.4)}
    .speech-bubble::after{content:'';position:absolute;bottom:0;left:50%;width:0;height:0;border:20px solid transparent;border-top-color:#fff;border-bottom:0;border-left:0;margin-left:-10px;margin-bottom:-20px}
    .caption-box{position:absolute;background:#f59e0b;color:#000;padding:8px;font-weight:bold;border-top:4px solid #000;border-bottom:4px solid #000;width:100%;text-align:center}
    .option-card:hover{transform:translateY(-5px)}
    .option-card.selected{border-color:#f59e0b;box-shadow:0 0 15px rgba(245,158,11,.5)}
  </style>
</head>
<body class="text-white p-4">
  <div id="main-container" class="max-w-6xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="bangers-font text-6xl text-amber-400" style="text-shadow:3px 3px #000;">AI Çizgi Roman Atölyesi</h1>
      <p class="text-gray-400">Hikayeni yaz, tarzını seç ve yapay zekanın senin için çizmesini izle!</p>
    </header>

    <!-- AŞAMA 1 -->
    <div id="step-1" class="bg-gray-800 p-6 rounded-lg shadow-2xl">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="story-input" class="block text-lg font-bold mb-2">1. Hikaye Özeti</label>
          <textarea id="story-input" rows="8" class="w-full bg-gray-900 border-2 border-gray-700 rounded-md p-3 focus:border-amber-500 focus:ring-0 transition" placeholder="Örn: Kayıp siber-kedisini arayan bir android..."></textarea>
        </div>
        <div>
          <label class="block text-lg font-bold mb-2">2. Sanat Tarzı</label>
          <div id="style-options" class="grid grid-cols-2 gap-4">
            <div class="option-card bg-gray-900 border-2 border-gray-700 p-4 rounded-md text-center cursor-pointer transition" data-style="Vintage Comic Book">Vintage Çizgi Roman</div>
            <div class="option-card bg-gray-900 border-2 border-gray-700 p-4 rounded-md text-center cursor-pointer transition" data-style="Anime / Manga">Manga / Anime</div>
            <div class="option-card bg-gray-900 border-2 border-gray-700 p-4 rounded-md text-center cursor-pointer transition" data-style="Cyberpunk Noir">Siberpunk Noir</div>
            <div class="option-card bg-gray-900 border-2 border-gray-700 p-4 rounded-md text-center cursor-pointer transition" data-style="Fantasy Watercolor">Fantastik Suluboya</div>
          </div>
        </div>
      </div>
      <button id="generate-btn" class="w-full mt-6 bangers-font text-3xl bg-amber-500 text-black py-3 rounded-md hover:bg-amber-600 transition-transform transform hover:scale-105">Çizgi Romanı Oluştur!</button>
    </div>

    <!-- AŞAMA 2 -->
    <div id="step-2" class="hidden">
      <div id="comic-page" class="grid grid-cols-2 grid-rows-2 gap-2 bg-black p-2 rounded-lg shadow-inner max-w-4xl mx-auto"></div>
      <div id="controls" class="mt-6 text-center">
        <p class="mb-4 text-gray-400">Panellere tıklayarak konuşma balonu veya anlatıcı metni ekleyebilirsiniz.</p>
        <button id="download-btn" class="bangers-font text-2xl bg-green-500 text-black py-2 px-8 rounded-md hover:bg-green-600 transition">İndir</button>
        <button id="restart-btn" class="bangers-font text-2xl bg-gray-500 text-black py-2 px-8 rounded-md hover:bg-gray-600 transition">Yeniden Başla</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="dialog-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-sm">
      <h3 class="text-xl font-bold mb-4">Metin Ekle</h3>
      <textarea id="dialog-input" class="w-full bg-gray-900 border-2 border-gray-700 rounded-md p-2" rows="3"></textarea>
      <div class="mt-4 flex justify-between">
        <div>
          <button id="add-bubble-btn" class="bg-blue-500 px-4 py-2 rounded-md hover:bg-blue-600">Konuşma Balonu</button>
          <button id="add-caption-btn" class="bg-amber-500 px-4 py-2 rounded-md hover:bg-amber-600">Anlatıcı Metni</button>
        </div>
        <button id="close-modal-btn" class="bg-red-500 px-4 py-2 rounded-md hover:bg-red-600">Kapat</button>
      </div>
    </div>
  </div>

<script>
  // --- STATE ---
  let selectedStyle = null;
  let activePanel = null;

  // --- DOM ---
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const styleOptions = document.getElementById('style-options');
  const generateBtn = document.getElementById('generate-btn');
  const comicPage = document.getElementById('comic-page');
  const dialogModal = document.getElementById('dialog-modal');

  // --- UI EVENTS ---
  styleOptions.addEventListener('click', (e) => {
    if (e.target.classList.contains('option-card')) {
      document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
      e.target.classList.add('selected');
      selectedStyle = e.target.dataset.style;
    }
  });

  generateBtn.addEventListener('click', generateComic);
  document.getElementById('restart-btn').addEventListener('click', () => location.reload());
  document.getElementById('download-btn').addEventListener('click', () => {
    html2canvas(comicPage).then(canvas => {
      const link = document.createElement('a');
      link.download = 'ai-cizgi-roman.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  });

  // Modal
  comicPage.addEventListener('click', (e) => {
    if (e.target.closest('.comic-panel')) {
      activePanel = e.target.closest('.comic-panel');
      dialogModal.style.display = 'flex';
    }
  });
  document.getElementById('close-modal-btn').addEventListener('click', () => dialogModal.style.display = 'none');
  document.getElementById('add-bubble-btn').addEventListener('click', () => addTextToPanel('bubble'));
  document.getElementById('add-caption-btn').addEventListener('click', () => addTextToPanel('caption'));

  function addTextToPanel(type) {
    const text = document.getElementById('dialog-input').value;
    if (!text || !activePanel) return;
    const el = document.createElement('div');
    el.innerText = text;
    if (type === 'bubble') { el.className = 'speech-bubble'; el.style.top = '10%'; el.style.left = '10%'; }
    else { el.className = 'caption-box'; el.style.bottom = '0'; }
    activePanel.appendChild(el);
    document.getElementById('dialog-input').value = '';
    dialogModal.style.display = 'none';
  }

  // --- CORE AI: /api uçlarına istek atıyoruz ---
  async function generateComic() {
    const story = document.getElementById('story-input').value;
    if (!story || !selectedStyle) { alert('Lütfen hikaye ve stil seç.'); return; }
    step1.classList.add('hidden');
    step2.classList.remove('hidden');
    renderPanelLoaders();

    try {
      const r1 = await fetch('/api/breakdown', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ story, style: selectedStyle })
      });
      if (!r1.ok) throw new Error(await r1.text());
      const { panels } = await r1.json();

      const urls = await Promise.all(
        panels.map(p =>
          fetch('/api/image', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: `${p.description}, in the style of ${selectedStyle}, comic book panel art, vibrant colors, dynamic angle.` })
          })
          .then(r => { if(!r.ok) throw new Error('image api'); return r.json(); })
          .then(d => `data:image/png;base64,${d.imageBase64}`)
        )
      );

      renderPanels(urls);
    } catch (err) {
      console.error(err);
      comicPage.innerHTML = `<p class="col-span-2 text-center text-red-500">Bir hata oluştu. (Muhtemelen API yetki/billing)</p>`;
    }
  }

  function renderPanelLoaders() {
    comicPage.innerHTML = '';
    for (let i = 0; i < 4; i++) {
      const panel = document.createElement('div');
      panel.className = 'comic-panel aspect-square flex items-center justify-center';
      panel.innerHTML = `<div class="text-center"><div class="panel-loader w-12 h-12 mx-auto border-4 rounded-full"></div><p class="mt-2 text-gray-400">Panel ${i+1} çiziliyor...</p></div>`;
      comicPage.appendChild(panel);
    }
  }

  function renderPanels(urls) {
    comicPage.innerHTML = '';
    urls.forEach(url => {
      const panel = document.createElement('div');
      panel.className = 'comic-panel aspect-square';
      panel.style.backgroundImage = `url(${url})`;
      panel.style.backgroundSize = 'cover';
      panel.style.backgroundPosition = 'center';
      comicPage.appendChild(panel);
    });
  }
</script>
</body>
</html>
